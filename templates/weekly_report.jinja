{% extends "base.jinja" %}

{% macro player_section(players, section_title, slot_filter, no_data_message) %}
    <div class="sub-section-title"{% if section_title == 'Bench' %} style="margin-top: 2em;"{% endif %}>{{ section_title }}</div>
    {% for player in players if (slot_filter == 'ne' and player.slot_position != 'BE') or (slot_filter == 'eq' and player.slot_position == 'BE') %}
        <div class="player-breakdown">
        <div class="player-info">
            <div class="player-details-line">
                <img src="logo_svg/{{ player.pro_team }}.svg" class="nfl-logo player-info-nfl-logo" />
                <!--
                <div class="player-headshot"><img height="35px" width="48px" alt="{{ player.name }}" src="https://a.espncdn.com/combiner/i?img=/i/headshots/nfl/players/full/{{ player.id }}.png&amp;w=96&amp;h=70&amp;cb=1"></div>
                -->
                <strong>{{ player.name }}</strong> ({{ player.position }})
                {% if player.high_roller_fines > 0 %}
                    <span title="Fines" class="high-roller-fines">üí∞: ${{ player.high_roller_fines }}</span>
                {% endif %}
            </div>

            <div class="player-total-points">
                <span class="actual-points">{{ player.points|format_score }}</span> / <span class="projected-points">{{ player.projected_points|format_score }}</span>
            </div>
        </div>
        <div class="player-feature-stats">
            <span title="Age/Birth Date">‚åõ: {{ player.beef_age }} <span class="player-feature-stats-small" title="Birth Date">({{ player.beef_birth_date }}) <span title="{{ player.zodiac_emoji }} {{ zodiac_names.get(player.zodiac_emoji, '') }}">{{ player.zodiac_emoji }}</span></span></span>
            <span><span title="Weight">ü•©: {{ player.beef_weight }}</span> lbs <span class="player-feature-stats-small" title="tabbu">({{ player.beef_tabbu }})</span></span>
            <span title="Height">ü¶í: {{ player.beef_height }}</span>
            <span title="Years of Experience">üóìÔ∏è: {{ player.beef_years_exp }}</span>
        </div>
            <div class="stats-table-container">
                <table class="data-table stats-breakdown-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for header in player.stats_table.headers %}
                                <th title="{{ header.label }}" tabindex="0">{{ header.abbr }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Actual</td>
                            {% for cell in player.stats_table.actual %}
                                <td class="{{ cell.style }}">{{ cell.value|format_score }}</td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td>Projected</td>
                            {% for cell in player.stats_table.projected %}
                                <td class="{{ cell.style }}">{{ cell.value|format_score }}</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <p>{{ no_data_message }}</p>
    {% endfor %}
{% endmacro %}

{% block title %}Fantasy Football Weekly Report - Week {{ week }}{% endblock %}

{% block content %}
<h1>{{ year }} NFL Week {{ week }}</h1>

<!-- Box Score Section -->
<div class="section">
    <div class="section-title">Box Score</div>
    <hr>
    <div class="box-score">
        <div class="box-score-header">
            <div>Away</div>
            <div>Home</div>
        </div>

        {% for matchup in matchups %}
        <div class="matchup-row">
            <div class="team-section {% if matchup.winner == 'away' %}winner-bg{% elif matchup.winner == 'home' %}loser-bg{% endif %}">
                <div class="team-main-score">
                    <span class="team-name"><span class="logo-container"><img class='logo' src='{{ matchup.away_team.logo }}' /> </span> {{ matchup.away_team.abbrev }}</span>
                    <span class="team-score">{{ matchup.away_team.score|format_score }}</span>
                </div>
                <div class="team-sub-scores">
                    <div class="sub-score-row">
                        <span class="sub-score-label">MAX:</span>
                        <span class="sub-score-value">
                            {{ matchup.away_team.max_score|format_score }}
                            {% if matchup.winner == 'home' and matchup.lost_could_win %} <strong class="dead">üíÄ</strong>{% endif %}
                        </span>
                    </div>
                    <div class="sub-score-row">
                        <span class="sub-score-label">BEN:</span>
                        <span class="sub-score-value">
                            {{ matchup.away_team.bench|format_score }}
                            {% if matchup.away_team.bench_outscored %} <span class="clown">ü§°</span>{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="vs-symbol">vs</div>

            <div class="team-section {% if matchup.winner == 'home' %}winner-bg{% elif matchup.winner == 'away' %}loser-bg{% endif %}">
                <div class="team-main-score">
                    <span class="team-name"><span class="logo-container"><img class='logo' src='{{ matchup.home_team.logo }}' /></span> {{ matchup.home_team.abbrev }}</span>
                    <span class="team-score">{{ matchup.home_team.score|format_score }}</span>
                </div>
                <div class="team-sub-scores">
                    <div class="sub-score-row">
                        <span class="sub-score-label">MAX:</span>
                        <span class="sub-score-value">
                            {{ matchup.home_team.max_score|format_score }}
                            {% if matchup.winner == 'away' and matchup.lost_could_win %} <strong class="dead">üíÄ</strong>{% endif %}
                        </span>
                    </div>
                    <div class="sub-score-row">
                        <span class="sub-score-label">BEN:</span>
                        <span class="sub-score-value">
                            {{ matchup.home_team.bench|format_score }}
                            {% if matchup.home_team.bench_outscored %} <span class="clown">ü§°</span>{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="legend">
            <div>ü§° = <em>Team's bench outscored starters</em></div>
            <div>üíÄ = <em>Team that lost could have won</em></div>
            <div><em>MAX = Maximum possible score</em></div>
            <div><em>BEN = Total points left on the bench</em></div>
        </div>
    </div>
</div>

<!-- League Standings Section -->
<div class="section">
    <div class="section-title">League Standings</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th>Rec</th>
                <th>Div</th>
                <th>Team</th>
                <th class="text-right">PF</th>
                <th class="text-right">PA</th>
            </tr>
        </thead>
        <tbody>
            {% for team in standings %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ team.wins }} - {{ team.losses }}</td>
                <td class="text-center"><em>{{ div_images[team.division_name[:1]]|safe }}</em></td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ team.logo }}' /> </span>{{ team.team_name }}</td>
                <td class="text-right">{{ team.points_for|format_score }}</td>
                <td class="text-right">{{ team.points_against|format_score }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="legend">
        <div><em>{{ div_images['F']|safe }} = Fireball division</em></div>
        <div><em>{{ div_images['J']|safe }} = Jager division</em></div>
    </div>
</div>

<!-- Power Rankings Section -->
<div class="section">
    <div class="section-title">Power Rankings</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-right">Score</th>
                <th class="text-center">Div</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for rank in power_rankings %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-right">{{ rank[0]|format_score }}</td>
                <td class="text-center"><em>{{ div_images[rank[1].division_name[:1]]|safe }}</em></td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ rank[1].logo }}' /> </span>{{ rank[1].team_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="legend">
        <div><em>{{ div_images['F']|safe }} = Fireball division</em></div>
        <div><em>{{ div_images['J']|safe }} = Jager division</em></div>
        <div><em>Calculated using two step dominance, whatever that is. <a
                    href='https://github.com/cwendt94/espn-api/blob/master/espn_api/football/league.py#L230'
                    target='_new'>code</a></em></div>
    </div>
</div>

<!-- League Overview Section -->
<div class="section">
    <div class="section-title">League Overview</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th colspan=3>Week</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Highest scoring week</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ top_week[0].logo }}' /> </span>{{ top_week[0].team_name }}</td>
                <td>{{ top_week[1]|round(2) }}</td>
            </tr>
            <tr>
                <td>Lowest scoring week</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ low_week[0].logo }}' /> </span>{{ low_week[0].team_name }}</td>
                <td>{{ low_week[1]|round(2) }}</td>
            </tr>
            {% if largest_weekly_margin %}
            <tr>
                <td>Margin of Victory</td>
                <td>{{ largest_weekly_margin.winner_name }} ({{ largest_weekly_margin.winner_score|round(2) }} - {{ largest_weekly_margin.loser_score|round(2) }})</td>
                <td>{{ largest_weekly_margin.margin|round(2) }}</td>
            </tr>
            {% endif %}
        </tbody>
        <thead>
            <tr>
                <th colspan=3>Season</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Top Scorer</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ top_scorer.logo }}' /> </span>{{ top_scorer.team_name }}</td>
                <td>{{ top_scorer.points_for|round(2) }}</td>
            </tr>
            <tr>
                <td>Low Scorer</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ low_scorer.logo }}' /> </span>{{ low_scorer.team_name }}</td>
                <td>{{ low_scorer.points_for|round(2) }}</td>
            </tr>
            <tr>
                <td>Most Points Against</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ most_pa.logo }}' /> </span>{{ most_pa.team_name }}</td>
                <td>{{ most_pa.points_against|round(2) }}</td>
            </tr>
            {% if largest_season_margin %}
            <tr>
                <td>Margin of Victory</td>
                <td>{{ largest_season_margin.winner_name }} ({{ largest_season_margin.winner_score|round(2) }} - {{ largest_season_margin.loser_score|round(2) }})</td>
                <td>{{ largest_season_margin.margin|round(2) }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

</div>

<!-- Weekly Scores Section -->
<div class="section">
    <div class="section-title">Weekly Scores</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-right">Score</th>
                <th class="text-center">?</th>
                <th>Div</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for score in weekly_scores %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-right">{{ score.score|format_score }}</td>
                <td class="text-center">
                    {% if score.won %}
                        <span class="result-win">W</span>
                    {% else %}
                        <span class="result-loss">L</span>
                    {% endif %}
                </td>
                <td class="text-center">{{ div_images[score.division]|safe }}</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ score.logo }}' /> </span>{{ score.name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Weekly Max Scores Section -->
<div class="section">
    <div class="section-title">Weekly Max Scores</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-right">Score</th>
                <th class="text-center">?</th>
                <th>Div</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for score in weekly_scores|sort(attribute='max_score', reverse=True) %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-right">{{ score.max_score|format_score }}</td>
                <td class="text-center">
                    {% if score.won %}
                        <span class="result-win">W</span>
                    {% else %}
                        <span class="result-loss">L</span>
                    {% endif %}
                </td>
                <td class="text-center">{{ div_images[score.division]|safe }}</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ score.logo }}' /> </span>{{ score.name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Weekly Bench Scores Section -->
<div class="section">
    <div class="section-title">Weekly Bench Scores</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-right">Score</th>
                <th class="text-center">?</th>
                <th>Div</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for score in weekly_scores|sort(attribute='bench_score', reverse=True) %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-right">{{ score.bench_score|format_score }}</td>
                <td class="text-center">
                    {% if score.won %}
                        <span class="result-win">W</span>
                    {% else %}
                        <span class="result-loss">L</span>
                    {% endif %}
                </td>
                <td class="text-center">{{ div_images[score.division]|safe }}</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ score.logo }}' /> </span>{{ score.name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Demographics Section -->
<div class="section">
    <div class="section-title">Demographics</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th colspan=3>Team</th>
            </tr>
        </thead>
        <tbody>
            {% if oldest_team %}
            <tr>
                <td>Oldest</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ oldest_team.team_object.logo }}' /> </span>{{ oldest_team.name }}</td>
                <td>‚åõ&nbsp;{{ oldest_team.avg_age|round(1) }}</td>
            </tr>
            {% endif %}
            {% if youngest_team %}
            <tr>
                <td>Youngest</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ youngest_team.team_object.logo }}' /> </span>{{ youngest_team.name }}</td>
                <td>‚åõ&nbsp;{{ youngest_team.avg_age|round(1) }}</td>
            </tr>
            {% endif %}
            {% if most_experienced_team %}
            <tr>
                <td>Most Exp</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ most_experienced_team.team_object.logo }}' /> </span>{{ most_experienced_team.name }}</td>
                <td>üóìÔ∏è&nbsp;{{ most_experienced_team.avg_years_exp|round(1) }}</td>
            </tr>
            {% endif %}
            {% if least_experienced_team %}
            <tr>
                <td>Least Exp</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ least_experienced_team.team_object.logo }}' /> </span>{{ least_experienced_team.name }}</td>
                <td>üóìÔ∏è&nbsp;{{ least_experienced_team.avg_years_exp|round(1) }}</td>
            </tr>
            {% endif %}
            {% if tallest_team %}
            <tr>
                <td>Tallest</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ tallest_team.team_object.logo }}' /> </span>{{ tallest_team.name }}</td>
                <td>ü¶í&nbsp;{{ tallest_team.avg_height }}</td>
            </tr>
            {% endif %}
            {% if shortest_team %}
            <tr>
                <td>Shortest</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ shortest_team.team_object.logo }}' /> </span>{{ shortest_team.name }}</td>
                <td>ü¶í&nbsp;{{ shortest_team.avg_height }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th colspan=3>Player</th>
            </tr>
        </thead>
        <tbody>
            {% if oldest_player %}
            <tr>
                <td>Oldest</td>
                <td><img src="logo_svg/{{ oldest_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ oldest_player.name }}</strong> ({{ oldest_player.position }}) - {{ oldest_player.team_name }}</td>
                <td>‚åõ&nbsp;{{ oldest_player.beef_age }}</td>
            </tr>
            {% endif %}
            {% if youngest_player %}
            <tr>
                <td>Youngest</td>
                <td><img src="logo_svg/{{ youngest_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ youngest_player.name }}</strong> ({{ youngest_player.position }}) - {{ youngest_player.team_name }}</td>
                <td>‚åõ&nbsp;{{ youngest_player.beef_age }}</td>
            </tr>
            {% endif %}
            {% if most_experienced_player %}
            <tr>
                <td>Most Exp</td>
                <td><img src="logo_svg/{{ most_experienced_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ most_experienced_player.name }}</strong> ({{ most_experienced_player.position }}) - {{ most_experienced_player.team_name }}</td>
                <td>üóìÔ∏è&nbsp;{{ most_experienced_player.beef_years_exp }}</td>
            </tr>
            {% endif %}
            {% if least_experienced_player %}
            <tr>
                <td>Least Exp</td>
                <td><img src="logo_svg/{{ least_experienced_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ least_experienced_player.name }}</strong> ({{ least_experienced_player.position }}) - {{ least_experienced_player.team_name }}</td>
                <td>üóìÔ∏è&nbsp;{{ least_experienced_player.beef_years_exp }}</td>
            </tr>
            {% endif %}
            {% if tallest_player %}
            <tr>
                <td>Tallest</td>
                <td><img src="logo_svg/{{ tallest_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ tallest_player.name }}</strong> ({{ tallest_player.position }}) - {{ tallest_player.team_name }}</td>
                <td>ü¶í&nbsp;{{ tallest_player.beef_height }}</td>
            </tr>
            {% endif %}
            {% if shortest_player %}
            <tr>
                <td>Shortest</td>
                <td><img src="logo_svg/{{ shortest_player.pro_team }}.svg" class="nfl-logo" /><strong>{{ shortest_player.name }}</strong> ({{ shortest_player.position }}) - {{ shortest_player.team_name }}</td>
                <td>ü¶í&nbsp;{{ shortest_player.beef_height }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
<!-- Upcoming & Recent Birthdays Section -->
<div class="section">
    <div class="section-title">üéÇ Upcoming & Recent Birthdays</div>
    <hr>
    {% if upcoming_recent_birthdays %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Player</th>
                <th>Pos.</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for birthday in upcoming_recent_birthdays %}
            <tr>
                <td>{{ birthday.birth_date }}</td>
                <td><img src="{{ birthday.pro_team_logo }}" class="nfl-logo" />{{ birthday.name }}</td>
                <td>{{ birthday.position }}</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ birthday.team_logo }}' /> </span>{{ birthday.team_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No upcoming or recent birthdays for players on fantasy teams.</p>
    {% endif %}
</div>


<!-- Beef Rankings Section -->
<div class="section">
    <div class="section-title">ü•© Beef Rankings</div>
    <hr>
    {% if beef_rankings %}
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th>Team</th>
                <th class="text-right">Weight</th>
                <th>TABBU</th>
            </tr>
        </thead>
        <tbody>
            {% for team in beef_rankings %}
            <tr>
                <td class="text-center">{{ team.rank }}</td>
                <td><span class="logo-container-sm"><img class='logo' src='{{ team.team_logo }}' /> </span>{{ team.team_name }}</td>
                <td class="text-right">{{ team.total_weight|round(1) }} lbs</td>
                <td class="tabbu-emojis">{{ team.tabbu_emojis }} <span class="tabbu-score">({{ team.total_tabbu|round(2) }})</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="legend">
        <div><em>TABBU = Total Adjusted Beef Body Units</em></div>
        <div><em>üêÆ = 1200 lbs = 2.4 TABBU, ü•© = 0.5 TABBU = 250 lbs.</em></div>
    </div>
    {% else %}
    <p>No beef data available to rank.</p>
    {% endif %}
</div>

<!-- Zodiac Distribution Charts Section -->
<div class="section">
    <div class="section-title">üåíüåò Zodiac Distribution</div>
    <hr>
    <div style="width: 95%; margin: auto;">
        <canvas id="zodiacRadarChart"></canvas>
    </div>
    <div style="width: 95%; margin: auto;">
        <canvas id="zodiacPieChart"></canvas>
    </div>
</div>


<!-- Points Breakdown Charts Section -->
<div class="section">
    <div class="section-title">Points Breakdown</div>
    <hr>
    <div style="width: 95%; margin: auto;">
        <canvas id="radarChart"></canvas>
    </div>
    <div style="width: 95%; margin: auto;">
        <canvas id="pointsPieChart"></canvas>
    </div>
    <div id="barChartContainer" style="display: none; margin-top: 20px;">
        <h3 id="barChartTitle" style="text-align: center;"></h3>
        <canvas id="pointsBarChart"></canvas>
    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function transparentize(hexColor, alpha) {
        let color = hexColor.startsWith('#') ? hexColor.slice(1) : hexColor;
        if (color.length === 3) {
            color = color.split('').map(char => char + char).join('');
        }
        const r = parseInt(color.substring(0, 2), 16);
        const g = parseInt(color.substring(2, 4), 16);
        const b = parseInt(color.substring(4, 6), 16);
        const a = Math.max(0, Math.min(1, alpha));
        return `rgba(${r}, ${g}, ${b}, ${a})`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const groupedData = {{ grouped_points_breakdown|tojson }};
        const detailedData = {{ detailed_points_breakdown|tojson }};
        // Data for the radar chart, assumed to be passed from the backend
        const radarChartData = {{ radar_chart_data|tojson }}; // This variable needs to be populated in the Python backend

        const baseColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#7FDBDA', '#FF9F40',
            '#FFB3C1', '#A3D9B1', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00'
        ];

        const radarCtx = document.getElementById('radarChart');
        if (radarCtx && radarChartData && radarChartData.labels && radarChartData.datasets) {
            const radarDatasets = radarChartData.datasets.map((dataset, index) => {
                const color = baseColors[index % baseColors.length];
                return {
                    label: dataset.label,
                    data: dataset.data,
                    backgroundColor: transparentize(color, 0.2),
                    borderWidth: 1,
                    borderColor: color,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: color
                };
            });

            new Chart(radarCtx.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: radarChartData.labels,
                    datasets: radarDatasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Team Performance by Stat Category'
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: false
                            },
                            suggestedMin: 0,
                            ticks: {
                                display: false // Hide the numerical labels on the axis
                            }
                        }
                    }
                }
            });
        }

        const pieCtx = document.getElementById('pointsPieChart');
        if (pieCtx) {
            const pieChart = new Chart(pieCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(groupedData),
                    datasets: [{
                        data: Object.values(groupedData),
                        backgroundColor: baseColors.map(color => transparentize(color, 0.6)),
                        borderColor: baseColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            onClick: (e, legendItem, legend) => {
                                const index = legend.chart.data.labels.indexOf(legendItem.text);
                                const color = legend.chart.data.datasets[0].borderColor[index];
                                updateBarChart(legendItem.text, color);
                            }
                        },
                        title: {
                            display: true,
                            text: 'Aggregated Points by Category'
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const clickedIndex = elements[0].index;
                            const clickedCategory = pieChart.data.labels[clickedIndex];
                            const color = pieChart.data.datasets[0].borderColor[clickedIndex];
                            updateBarChart(clickedCategory, color);
                        }
                    }
                }
            });
        }

        const barChartContainer = document.getElementById('barChartContainer');
        const barChartTitle = document.getElementById('barChartTitle');
        const barCtx = document.getElementById('pointsBarChart');
        let barChart;

        function updateBarChart(category, color) {
            const categoryData = detailedData.filter(d => d.category === category);

            categoryData.sort((a, b) => b.total_points - a.total_points);

            const labels = categoryData.map(d => d.label);
            const data = categoryData.map(d => d.total_points);

            barChartTitle.innerText = `Breakdown for ${category}`;
            barChartContainer.style.display = 'block';

            if (barChart) {
                barChart.destroy();
            }

            if (barCtx) {
                barChart = new Chart(barCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Points',
                            data: data,
                            backgroundColor: transparentize(color, 0.5),
                            borderColor: color,
                            borderWidth: 2,
                            borderRadius: 5,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // --- Zodiac Charts ---
        const zodiacRadarData = {{ zodiac_radar_chart_data|tojson }};
        const zodiacPieData = {{ zodiac_pie_chart_data|tojson }};

        // Zodiac Radar Chart
        const zodiacRadarCtx = document.getElementById('zodiacRadarChart');
        if (zodiacRadarCtx && zodiacRadarData.datasets.length > 0) {
            const zodiacRadarChart = new Chart(zodiacRadarCtx.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: zodiacRadarData.labels,
                    datasets: zodiacRadarData.datasets.map((dataset, index) => ({
                        label: dataset.label,
                        data: dataset.data,
                        backgroundColor: transparentize(baseColors[index % baseColors.length], 0.2),
                        borderColor: baseColors[index % baseColors.length],
                        borderWidth: 2,
                        pointBackgroundColor: baseColors[index % baseColors.length],
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: baseColors[index % baseColors.length]
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Player Count by Zodiac Sign (Team Comparison)'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Zodiac Pie Chart
        const zodiacPieCtx = document.getElementById('zodiacPieChart');
        if (zodiacPieCtx && zodiacPieData.data.some(value => value > 0)) {
            const zodiacPieChart = new Chart(zodiacPieCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: zodiacPieData.labels,
                    datasets: [{
                        data: zodiacPieData.data,
                        backgroundColor: zodiacPieData.labels.map((_, index) =>
                            transparentize(baseColors[index % baseColors.length], 0.8)
                        ),
                        borderColor: zodiacPieData.labels.map((_, index) =>
                            baseColors[index % baseColors.length]
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'League-wide Zodiac Distribution'
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

    });
</script>

<!-- Player Stats Section -->
<div class="section">
    <div class="section-title">Top 15 Player Scores</div>
    <hr>
    <table class="data-table">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-right">Score</th>
                <th>Pos.</th>
                <th>Player</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody>
            {% for player in top_overall_players %}
            <tr {% if player.slot_position == 'BE' %}class="bench-player"{% endif %}>
                <td class="text-center">{{ loop.index }}</td>
                <td class="text-right">{{ player.points|format_score }}</td>
                <td>{{ player.position }}</td>
                <td><img src="logo_svg/{{ player.pro_team }}.svg" class="nfl-logo" />{{ player.name }}</td>
                <td>
                    {% if player.slot_position == 'BE' %}
                        <span class="clown">ü§°</span> {{ player.team_abbrev }}
                    {% elif player.team_abbrev == 'FA' %}
                       <span class="logo-container-sm"><img class='logo' src='logo_svg/NFL.svg' /> </span> {{ player.team_abbrev }}
                    {% else %}
                        <span class="logo-container-sm"><img class='logo' src='{{ player.team_logo }}' /> </span>{{ player.team_abbrev }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="section">
    <div class="section-title">Top 15 by Position</div>
    <hr>
    {% for position, players in top_players_by_position.items() %}
    <div class="sub-section">
        <div class="sub-section-title">{{ position }}</div>
        <table class="data-table">
            <thead>
                <tr>
                    <th class="text-center">#</th>
                    <th class="text-right">Score</th>
                    <th>Player</th>
                    <th>Team</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr {% if player.slot_position == 'BE' %}class="bench-player"{% endif %}>
                    <td class="text-center">{{ loop.index }}</td>
                    <td class="text-right">{{ player.points|format_score }}</td>
                    <td><img src="logo_svg/{{ player.pro_team }}.svg" class="nfl-logo" />{{ player.name }}</td>
                    <td>
                    {% if player.slot_position == 'BE' %}
                        <span class="clown">ü§°</span> {{ player.team_abbrev }}
                    {% elif player.team_abbrev == 'FA' %}
                       <span class="logo-container-sm"><img class='logo' src='logo_svg/NFL.svg' /> </span> {{ player.team_abbrev }}
                    {% else %}
                        <span class="logo-container-sm"><img class='logo' src='{{ player.team_logo }}' /> </span>{{ player.team_abbrev }}
                    {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>

<!-- New Points Per Player Section -->
<div class="section points-per-player-section">
    <div class="section-title">Points Per Player Breakdown</div>
    <hr>
    {% for team_name, team_data in players_by_team.items() %}
    {% set sanitized_team_name = team_name | replace(' ', '_') | replace(',', '') | replace('(', '') | replace(')', '') | replace("'", '') | replace('&', '') | replace('.', '') | replace('/', '') | replace('-', '') %}
        <div class="team-header">
        {# Assuming team logo is available on one of the players #}
        <img class='logo' src='{{ team_data.players[0].team_logo }}' />
        <div class="team-header-text-content">
            <span>{{ team_name }}</span>
            {% if team_data.team_object %}
            <div class="team-details">
                <span class="team-record">{{ team_data.team_object.wins }}-{{ team_data.team_object.losses }}{% if team_data.team_object.ties %}-{{ team_data.team_object.ties }}{% endif %}</span>
                <span class="team-division">{{ div_images[team_data.team_object.division_name[:1]]|safe }} {{ team_data.team_object.division_name }}</span>
                <span class="team-points">PF: {{ team_data.team_object.points_for|round(2) }} PA: {{ team_data.team_object.points_against|round(2) }}</span>
                <span class="team-moves">Adds: {{ team_data.team_object.acquisitions }} Drops: {{ team_data.team_object.drops }} Trades: {{ team_data.team_object.trades }} IR: {{ team_data.team_object.move_to_ir }}</span>
                <span class="team-playoff-pct">Playoff %: {{ (team_data.team_object.playoff_pct)|round(2) }}%</span>
                <span title="Average Weight">ü•©: {{ team_data.avg_weight|round(1) }} lbs</span>
                <span title="Average Height">ü¶í: {{ team_data.avg_height }}</span>
                <span title="Average Age">‚åõ: {{ team_data.avg_age|round(1) }}</span>
                <span title="Average Years Experience">üóìÔ∏è: {{ team_data.avg_years_exp|round(1) }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    <hr>
    <div class="team-chart-toggle">
        Points: <a href="#" onclick="showChart('{{ sanitized_team_name }}', 'pie'); return false;">ü•ß</a> |
        <a href="#" onclick="showChart('{{ sanitized_team_name }}', 'radar'); return false;">üï∏Ô∏è</a>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        Zodiac: <a href="#" onclick="showChart('{{ sanitized_team_name }}', 'zodiacPie'); return false;">ü•ß</a> |
        <a href="#" onclick="showChart('{{ sanitized_team_name }}', 'zodiacRadar'); return false;">üï∏Ô∏è</a>
    </div>

    <div id="pieChartContainer_{{ sanitized_team_name }}" class="team-points-breakdown-charts">
        <div style="width: 75%; margin: auto;">
            <canvas id="pointsPieChart_{{ sanitized_team_name }}"></canvas>
        </div>
        <div id="barChartContainer_{{ sanitized_team_name }}" style="display: none; margin-top: 20px;">
            <h3 id="barChartTitle_{{ sanitized_team_name }}" style="text-align: center;"></h3>
            <canvas id="pointsBarChart_{{ sanitized_team_name }}"></canvas>
        </div>
    </div>

    <div id="radarChartContainer_{{ sanitized_team_name }}" class="team-points-breakdown-charts" style="display: none;">
        <div style="width: 75%; margin: auto;">
            <canvas id="teamRadarChart_{{ sanitized_team_name }}"></canvas>
        </div>
    </div>

    <div id="zodiacPieChartContainer_{{ sanitized_team_name }}" class="team-points-breakdown-charts" style="display: none;">
        <div style="width: 75%; margin: auto;">
            <canvas id="teamZodiacPieChart_{{ sanitized_team_name }}"></canvas>
        </div>
    </div>

    <div id="zodiacRadarChartContainer_{{ sanitized_team_name }}" class="team-points-breakdown-charts" style="display: none;">
        <div style="width: 75%; margin: auto;">
            <canvas id="teamZodiacRadarChart_{{ sanitized_team_name }}"></canvas>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const teamGroupedData = {{ players_by_team[team_name].grouped_points_breakdown|tojson }};
            const teamDetailedData = {{ players_by_team[team_name].detailed_points_breakdown|tojson }};

            const pieCtx = document.getElementById('pointsPieChart_{{ sanitized_team_name }}');
            if (pieCtx) {
                const baseColors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#7FDBDA', '#FF9F40',
                    '#FFB3C1', '#A3D9B1', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00'
                ];
                const pieChart = new Chart(pieCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(teamGroupedData),
                        datasets: [{
                            data: Object.values(teamGroupedData),
                            backgroundColor: baseColors.map(color => transparentize(color, 0.6)),
                            borderColor: baseColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                onClick: (e, legendItem, legend) => {
                                    const index = legend.chart.data.labels.indexOf(legendItem.text);
                                    const color = legend.chart.data.datasets[0].borderColor[index];
                                    updateTeamBarChart(legendItem.text, color, '{{ sanitized_team_name }}');
                                }
                            },
                            title: {
                                display: true,
                                text: 'Aggregated Points by Category'
                            }
                        },
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const clickedIndex = elements[0].index;
                                const clickedCategory = pieChart.data.labels[clickedIndex];
                                const color = pieChart.data.datasets[0].borderColor[clickedIndex];
                                updateTeamBarChart(clickedCategory, color, '{{ sanitized_team_name }}');
                            }
                        }
                    }
                });
            }

            function updateTeamBarChart(category, color, teamId) {
                const teamDetailedData = {{ players_by_team[team_name].detailed_points_breakdown|tojson }};
                const barChartContainer = document.getElementById('barChartContainer_' + teamId);
                const barChartTitle = document.getElementById('barChartTitle_' + teamId);
                const barCtx = document.getElementById('pointsBarChart_' + teamId);
                let barChart = Chart.getChart(barCtx);

                const categoryData = teamDetailedData.filter(d => d.category === category);

                categoryData.sort((a, b) => b.total_points - a.total_points);

                const labels = categoryData.map(d => d.label);
                const data = categoryData.map(d => d.total_points);

                barChartTitle.innerText = `Breakdown for ${category}`;
                barChartContainer.style.display = 'block';

                if (barChart) {
                    barChart.destroy();
                }

                if (barCtx) {
                    new Chart(barCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Points',
                                data: data,
                                backgroundColor: transparentize(color, 0.5),
                                borderColor: color,
                                borderWidth: 2,
                                borderRadius: 5,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            }

            const radarCtx = document.getElementById('teamRadarChart_{{ sanitized_team_name }}');
            if (radarCtx) {
                const radarChartData = {{ team_data.radar_chart_data|tojson }};
                const baseColors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#7FDBDA', '#FF9F40',
                    '#FFB3C1', '#A3D9B1', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00'
                ];
                const color = baseColors[{{ loop.index0 }} % baseColors.length];

                new Chart(radarCtx.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: radarChartData.labels,
                        datasets: [{
                            label: radarChartData.datasets[0].label,
                            data: radarChartData.datasets[0].data,
                            backgroundColor: transparentize(color, 0.2),
                            borderColor: color,
                            pointBackgroundColor: color,
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: color
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Points by Category'
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: false
                                },
                                suggestedMin: 0,
                                ticks: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Zodiac Pie Chart
            const zodiacPieCtx = document.getElementById('teamZodiacPieChart_{{ sanitized_team_name }}');
            if (zodiacPieCtx) {
                const zodiacData = {{ team_data.zodiac_chart_data|tojson }};
                if (zodiacData.data && zodiacData.data.some(value => value > 0)) {
                    const baseColors = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#7FDBDA', '#FF9F40',
                        '#FFB3C1', '#A3D9B1', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00'
                    ];

                    new Chart(zodiacPieCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: zodiacData.labels,
                            datasets: [{
                                data: zodiacData.data,
                                backgroundColor: zodiacData.labels.map((_, index) =>
                                    transparentize(baseColors[index % baseColors.length], 0.6)
                                ),
                                borderColor: zodiacData.labels.map((_, index) =>
                                    baseColors[index % baseColors.length]
                                ),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'right'
                                },
                                title: {
                                    display: true,
                                    text: 'Team Zodiac Distribution'
                                }
                            }
                        }
                    });
                }
            }

            // Zodiac Radar Chart
            const zodiacRadarCtx = document.getElementById('teamZodiacRadarChart_{{ sanitized_team_name }}');
            if (zodiacRadarCtx) {
                const zodiacData = {{ team_data.zodiac_chart_data|tojson }};
                if (zodiacData.data && zodiacData.data.some(value => value > 0)) {
                    const baseColors = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#7FDBDA', '#FF9F40',
                        '#FFB3C1', '#A3D9B1', '#A52A2A', '#DEB887', '#5F9EA0', '#7FFF00'
                    ];
                    const color = baseColors[{{ loop.index0 }} % baseColors.length];

                    new Chart(zodiacRadarCtx.getContext('2d'), {
                        type: 'radar',
                        data: {
                            labels: zodiacData.labels,
                            datasets: [{
                                label: '{{ team_name }}',
                                data: zodiacData.data,
                                backgroundColor: transparentize(color, 0.2),
                                borderColor: color,
                                pointBackgroundColor: color,
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: color
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Team Zodiac Distribution'
                                }
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }
        });
    </script>

    {{ player_section(team_data.players, 'Starters', 'ne', 'No starters found for this team.') }}
    {{ player_section(team_data.players, 'Bench', 'eq', 'No bench players found for this team.') }}

    {% endfor %}
</div>


<!-- SUMMARY_REPORTS_PLACEHOLDER -->
{% endblock %}
